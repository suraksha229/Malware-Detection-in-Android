import csv
import os
import glob
from androguard.core.bytecodes.dvm import DalvikVMFormat
from androguard.core.analysis.analysis import VMAnalysis
from androguard.decompiler.decompiler import DecompilerDAD
from androguard.core.bytecodes.apk import APK
from androguard.core.analysis import analysis
from androguard.core.bytecodes import dvm

def extract_features(file_path):
    a = APK(file_path)
    d = DalvikVMFormat(a.get_dex())
    dx = VMAnalysis(d)
    vm = dvm.DalvikVMFormat(a.get_dex())
    vmx = analysis.uVMAnalysis(vm)
    d.set_vmanalysis(dx)
    d.set_decompiler(DecompilerDAD(d, dx))
    return a.get_permissions()  

text_file = open("unique_permission_in_benign.txt", "r")   
b_feature1 = text_file.readlines()
text_file.close()
text_file = open("unique_permission_in_malware.txt", "r")  
m_feature1 = text_file.readlines()
text_file.close()
feature_list=[]
for perm in b_feature1:
   perm2=perm.split('\n')
   feature_list.append(perm2[0])

for perm1 in m_feature1:
   perm3=perm1.split('\n')
   feature_list.append(perm3[0])
   
feature=set(feature_list)      
feature_list=[]
print(len(feature))
   
with open("train_file2.csv", "w") as csvfile: 
  
  for feat in feature:
     feature_list.append(feat)
     csvfile.write(feat)
     csvfile.write(',')
  csvfile.write('class')                       
  csvfile.write(',')
  os.chdir("/Users/rajgaurikhemnar/Desktop/15IT133_15IT147_M2/Malware") 
  max_case = 400                                                   
  i = 0
  permission_list = []
  
  for file in glob.glob("*"):
        if i<max_case:
            permissions = extract_features(file)
            if permissions is None:
                pass
            else:                
                for permission in permissions:
                    permission_list.append(permission)
            print "Progress: ",str((float(i)/float(max_case))*100.00),"%"    #it will show how much file it process
            i+=1
            csvfile.write('\n')
            
            print len(permission_list)
            for feat in feature :
              j=0
              for perm in permission_list:
                 if(feat==perm):
                     j=j+1
              if(j>0):
                    
                    csvfile.write('1')
                    csvfile.write(',')
              else:
                     
                     csvfile.write('0')
                     csvfile.write(',')
            csvfile.write('malware')                         
            csvfile.write(',')
  os.chdir("/Users/rajgaurikhemnar/Desktop/15IT133_15IT147_M2/Beningn") 
  max_apk = 400                                                   
  i = 0
  permission_list = []
  
  for file in glob.glob("*"):
        if i<max_apk:
            permissions = extract_features(file)
            if permissions is None:
                pass
            else:
                
                for permission in permissions:
                    permission_list.append(permission)
            i+=1
            csvfile.write('\n')
            
            print len(permission_list)
            for feat in feature :
              j=0;
              for perm in permission_list:
                 if(feat==perm):
                     j=j+1
              if(j>0):
                    csvfile.write('1')
                    csvfile.write(',')
              else:
                     csvfile.write('0')
                     csvfile.write(',')
            csvfile.write('beningn')                      
            csvfile.write(',')
